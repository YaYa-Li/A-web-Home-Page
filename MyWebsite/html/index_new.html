<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>首页</title>
	</head>
	<link rel="stylesheet/less" href="../css/index_new.less">
	<script src="../js/less-1.3.3.min.js"></script>
	<script src="../js/jquery-1.8.2.min.js"></script>
	<script src="../js/json2.js"></script>
	<script type="text/javascript" src="../js/combaSamCommon.js"></script>
	<!--图片自动切换插件-->
	<script src="../js/L_slide.js"></script>

	<body>
		<div align="center" style="margin-top:20px">
			<font class="reqname">体系管理门户</font>
		</div>
		<div id="bigDiv">
			<div id="top">
				<div id="top1" class="wrap af1">
					<ul class="slidebox">
						<li>
							<a href="#"><img src="../img/p1.jpg" /></a>
						</li>
						<li>
							<a href="#"><img src="../img/p2.jpg" /></a>
						</li>
						<li>
							<a href="#"><img src="../img/p3.jpg" /></a>
						</li>
						<li>
							<a href="#"><img src="../img/p4.jpg" /></a>
						</li>
					</ul>
				</div>
				<div id="top2">
					<div class="centerDivTitle">
						<img src="../img/Rectangle 7.png" />
						<font id="title1">特别通知</font>
						<font id="title2">Important Notice</font>
						<span><img src="../img/Group 4.png"/><font>培训园地 </font><div></div><img src="../img/Shape.png"/><font>联系我们</font> </span>
					</div>
					<table>
						<colgroup>
							<col width="13%">
							<col width="15%">
							<col width="40%">
						</colgroup>
					</table>
				</div>
			</div>
			<div id="center">
				<div class="centerDivTitle"><img src="../img/Rectangle 7.png" />
					<font id="title1">年度执行计划情况</font>
					<font id="title2">Annual Execution Plan</font>
					<span><a href="#">更多</a></span>
				</div>
				<div class="centerDivTitle2">
					<table cellspacing="0">
						<colgroup>
							<col width="4%">
							<col width="35%">
							<col width="25%">
							<col width="20%">
						</colgroup>
					</table>
				</div>
			</div>
			<div id="center2">
				<div class="centerDivTitle"><img src="../img/Rectangle 7.png" />
					<font id="title1">改善专项</font>
					<font id="title2">Improvement Project</font>
					<span><a href="#">更多</a></span>
				</div>
				<div class="centerDivTitle2">
					<table cellspacing="0">
						<colgroup>
							<col width="4%">
							<col width="35%">
							<col width="25%">
							<col width="20%">
						</colgroup>
					</table>
				</div>
			</div>
			<div id="center3" style="height:40px;width:auto;text-align: center;font-size: 15px;color: #000">
				浏览&nbsp;&nbsp;<span id="countVisitor" style="color: #0033FF;"></span>&nbsp;次
			</div>
			<!--<form id="tf" enctype="multipart/form-data" method="post">
    <input type='file' name='file' />
<input type="button" onclick="test()">上传</input>
</form>-->

		</div>

	</body>
	<script>
		$(function() {
			var userInfoList = {}; //存放用户信息
			var IENotice = "使用IE浏览器时，请点击IE浏览器的“工具->Internet 选项->安全->自定义级别”将“其他”选项中的“通过域访问数据源”选中为“启用”，点击确定就可以成功！";
			if(!countVisitor()) {
				alert(IENotice);
				return false;
			}
			if(!getUser()) {
				alert(IENotice);
				return false;
			}
			if(!listCombaQaNews()) {
				alert(IENotice);
				return false;
			}
			if(!listCombaQaPlans()) {
				alert(IENotice);
				return false;
			}
			if(!listCombaQaDevelops()) {
				alert(IENotice);
				return false;
			}
		});
	</script>
	<script type="text/javascript">
		/**
		 * 获取用户访问量
		 */
		function countVisitor() {
			var flag = true;
			var url = "http://172.16.0.140:8080/userVisitorInfos/count";
			console.log(url);
			getSYN(url, function(data) {
				console.log("countVisitor(returnData)-->" + data);
				if(data[0].isSuccess == 1) {
					console.log(data[0].message);
					console.log(data[0].list[0]);
					$("#countVisitor").html(parseInt(data[0].list[0]) + 1);
				} else {
					console.log(data[0].message);
				}
			}, function(data) {
				flag = false;
			});
			return flag;
		}

		/**
		 * 从OA中获取用户信息
		 */
		function getUser() {
			var flag = true;
			var url = "http://192.168.1.83/page/CombaPage/sam/jsp/index.jsp";
			console.log(url);
			getSYNFromOA(url, function(data) {
				console.log("getUser(returnData)-->" + JSON.stringify(data));
				userInfoList = data;
				if(!$.isEmptyObject(userInfoList)) {
					var visitorCount = $("#countVisitor").html();
					userInfoList.visitorCount = visitorCount;
					setUser(userInfoList);
				} else {
					alert("亲，您的登录信息可能已经失效，请重新登陆后再尝试");
				}

			}, function(data) {
				flag = false;
			});
			return flag;
		}
		/**
		 * 将本次访问的用户信息存放进后台
		 * @param {Object} importData
		 */
		function setUser(importData) {
			var flag = true;
			console.log("setUser(importData)-----" + JSON.stringify(importData));
			var url = "http://172.16.0.140:8080/userVisitorInfos";
			console.log(url);
			postSYN(url, importData, function(data) {
				console.log("setUser(returnData)-----" + JSON.stringify(data));
			}, function(data) {
				flag = false;
			});
			return flag;

		}

		/***
		 * 获取所有新闻列表数据
		 */
		function listCombaQaNews() {
			var flag = true;
			var url = "http://172.16.0.140:8080/combaQaNews";
			console.log(url);
			getSYN(url, function(data) {
				console.log("getData(returnData)-----" + JSON.stringify(data));
				console.log(data[0]);
				if(data[0].isSuccess == 1) {
					$.each(data[0].list, function(index, value) {
						//var str = '<tr><td class="bluefont"><img src="../img/椭圆形1.png" />' + value.TYPE + '</td><td>' + value.TIME + '</td><td>' + value.TITLE + '</td></tr>';
						var str = '<tr><td class="bluefont">' + value.TYPE + '</td><td>' + value.TIME + '</td><td style="text-align:left">' + value.TITLE + '</td></tr>';
						$("#top2 table").append(str);
					});
				} else {
					console.log(data[0].message);
				}
			}, function(data) {
				flag = false;
			});
			return flag;
		}

		/***
		 * 获取所有计划执行任务数据
		 */
		function listCombaQaPlans() {
			var flag = true;
			var url = "http://172.16.0.140:8080/combaQaPlans";
			console.log(url);
			getSYN(url, function(data) {
				console.log("getData(returnData)-----" + JSON.stringify(data));
				if(data[0].isSuccess == 1) {
					$.each(data[0].list, function(index, value) {
						var planStartDate = value.PLANSTARTDATE;
						if(planStartDate.substr(0, 4) <= 2017) {
							var flag = setLight(value.PLANSTARTDATE, value.PLANENDDATE);
							var lightSrc = ""
							var str = "";
							if(flag == 0) {
								lightSrc = "../img/4.png";
							} else if(flag == 1) {
								lightSrc = "../img/3.png";
							} else if(flag == 2) {
								lightSrc = "../img/2.png";
							}							
							if(value.TYPE == "【内部体系审核】"){
								 str = '<tr><td class="Img"><img src=' + lightSrc + '></td><td class="content"><div><span><span class="blue">' + value.TYPE + '</span>&nbsp;' + value.NAME + '</span><br>计划：' + value.PLANSTARTDATE + ' 至 ' + value.PLANENDDATE + '<br>完成情况：' + value.CONDITIONDESC + '</div></td>	<td class="status">状态：<span>' + value.STATUSNAME + '</span></td></tr>';
							}else{
								 str = '<tr><td class="Img"><img src=' + lightSrc + '></td><td class="content"><div><span><span class="blue">' + value.TYPE + '</span>&nbsp;' + value.NAME + '</span><br>计划：' + value.PLANSTARTDATE + ' 至 ' + value.PLANENDDATE + '<br>完成情况：' + value.CONDITIONDESC + '</div></td>	<td class="status">状态：<span>' + value.STATUSNAME + '</span></td><td class="time">证书获取时间：' + value.GETCERTIFICATEDATE + '</td></tr>';
							}						
							$("#center table").append(str);
						}

					});

				} else {
					console.log(data.message);
				}
			}, function(data) {
				flag = false;
			});
			return flag;
		}
		/***
		 * 获取所有发展专项数据
		 */
		function listCombaQaDevelops() {
			var flag = true;
			var url = "http://172.16.0.140:8080/combaQaDevelops";
			console.log(url);
			getSYN(url, function(data) {
				console.log("getData(returnData)-----" + JSON.stringify(data));
				if(data[0].isSuccess == 1) {
					$.each(data[0].list, function(index, value) {
						var flag = setLight(value.PLANSTARTDATE, value.PLANENDDATE);
						var lightSrc = ""
						if(flag == 0) {
							lightSrc = "../img/4.png";
						} else if(flag == 1) {
							lightSrc = "../img/3.png";
						} else if(flag == 2) {
							lightSrc = "../img/2.png";
						}
						var str = '<tr><td class="Img"><img src=' + lightSrc + '></td><td class="content"><div><span><span class="blue">' + value.TYPE + '</span>&nbsp;' + value.NAME + '</span><br>计划：' + value.PLANSTARTDATE + ' 至 ' + value.PLANENDDATE + '<br>完成情况：' + value.CONDITIONDESC + '</div></td>	<td class="status">状态：<span>' + value.STATUSNAME + '</span></td><td class="time">证书获取时间：' + value.GETCERTIFICATEDATE + '</td></tr>';
						$("#center2 table").append(str);
					});

				} else {
					console.log(data.message);
				}
			}, function(data) {
				flag = false;
			});
			return flag;
		}

		//  function test(){
		//      var form = new FormData(document.getElementById("tf"));
		//
		//      $.ajax({
		//          url:"http://192.168.8.172:8888/oa/page/CombaPage/wf/5644/test.jsp",
		//          type:"post",
		//          //data:"ddd",
		//          processData:false,
		//          contentType:"application/x-www-form-urlencoded; charset=utf-8",
		//          async: false,
		//          dataType: "script",
		//          success:function(){
		//              console.log("dd");
		//          },
		//          error:function(e){
		//              alert("错误！！");
		//          }
		//      });        
		//  }		
		/*
		 * 图片切换
		 */
		$(function() {
			//affect:1 2 3 4 （4种切换模式，可调）
			$(".af1").slide({
				affect: 3,
				time: 3000,
				speed: 400,
				dot_text: false,
			});
		})

		/*
		 * 年度计划指示灯设置
		 */
		function setLight(starDate, endDate) {
			var flag = 0; //默认绿灯
			var _endDate = endDate.replace(/-/g, ","); //转了格式
			//alert("endDateObj1"+_endDate.toString());
			//console.log("_endDate"+_endDate);

			var _endDateStr = _endDate.toString().split(","); //找出月份
			var endmonth = _endDateStr[1].replace(/0/g, ""); //把0去掉
			//	var endDateSolved = _endDateStr[0]+","+endmonth+","+_endDateStr[2];
			//	alert("endDateSolved"+endDateSolved);
			var endDateObj = new Date(_endDateStr[0], endmonth, _endDateStr[2]); //转为date对象
			//alert("endDateObj2"+endDateObj.toString());
			//console.log(endDateObj.toString());
			var warnDate = new Date(endDateObj);
			warnDate = warnDate.setDate(-90); //计划结束日期减90天 
			//console.log("warnDate=="+warnDate.toString());
			var now = new Date();
			//console.log(warnDate<now);
			if(warnDate > now) { //警告日期晚（大）于今天日期 绿灯
				return flag;
			} else {
				/*console.log("ddd"+endDateObj.getTime());
				console.log("ddd"+endDateObj.toString());
				console.log("dsds"+now.getTime());
				console.log("ddd"+now.toString());*/
				if(endDateObj < now) { //结束日期早（小）于今天日期  红灯
					flag = 1;
					return flag;
				} else {
					flag = 2; //黄
					return flag;
				}
			}

		}
	</script>
	<style>

	</style>

</html>